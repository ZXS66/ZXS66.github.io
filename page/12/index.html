<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<title>时代残党</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<link rel="icon" href="/favicon.png">
<meta property="og:type" content="website">
<meta property="og:title" content="时代残党">
<meta property="og:url" content="https://zxs66.github.io/page/12/">
<meta property="og:site_name" content="时代残党">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="时代残党">
<meta property="article:tag" content="C#">
<meta property="article:tag" content="Angular">
<meta property="article:tag" content="NodeJS">
<meta property="article:tag" content="SQL">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="ASP.NET">
<meta property="article:tag" content="Full Stack">
<meta name="twitter:card" content="summary">
<link rel="dns-prefetch" href="https://cdn.bootcdn.net/">
<link rel="dns-prefetch" href="https://fonts.googleapis.com/">
<link rel="dns-prefetch" href="https://fonts.gstatic.com/">
<meta name="baidu-site-verification" content="1W34rVIdAO" />

<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" crossorigin="anonymous" integrity="sha256-eZrrJcwDc&#x2F;3uDhsdt61sL2oOBY362qM3lon1gyExkL0&#x3D; sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN sha512-SfTiTlX6kk+qitfevl&#x2F;7LibUOeJWlt9rbyDn92a1DqWOw9vWG2MFoays0sgObmWazO5BQPiFucnnEAjpAB+&#x2F;Sw&#x3D;&#x3D;">


<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro" />


<link rel="stylesheet" href="/css/style.css">

<link rel="manifest" href="/manifest.json">
<script type="module" src="/pwabuilder-sw-register.js"></script>
<!-- 百度统计 -->
<script>
var _hmt = _hmt || [];
(function () {
var hm = document.createElement("script");
hm.src = "https://hm.baidu.com/hm.js?de1c4b02a9f8a51a6001797e045d3af9";
var s = document.getElementsByTagName("script")[0];
s.parentNode.insertBefore(hm, s);
})();
</script>
</head><body>
<div id="container">
<div id="wrap">
<header id="header">
<div id="banner"></div>
<div id="header-outer" class="outer">
<div id="header-title" class="inner">
<h1 id="logo-wrap">
<a href="/" id="logo">时代残党</a>
</h1>

<h2 id="subtitle-wrap">
<a href="/" id="subtitle">随手笔记</a>
</h2>

</div>
<div id="header-inner" class="inner">
<nav id="main-nav">
<a id="main-nav-toggle" class="nav-icon"></a>

<a class="main-nav-link" href="/">首页</a>

<a class="main-nav-link" href="/archives">归档</a>

<a class="main-nav-link" href="/app">联系我</a>

</nav>
<div id="search-form-wrap">
<div class="search-form"><input type="search" name="wd" class="search-form-input" placeholder="Search" list="search-datalist" autocomplete="false"/></div>

<input type="hidden" id="search-index-file" value="/search.json" />
<div id="search-form-datalist"></div>

</div>
<nav id="sub-nav">

<a id="nav-search-btn" class="nav-icon" title="搜索"></a>
</nav>
</div>
</div>
</header>
<div class="outer">
<section id="main">


<article id="post-CORS-review" class="article article-type-post" itemscope itemprop="blogPost">
<div class="article-meta">
<a href="/2021/04/11/CORS-review/" class="article-date">
  <time datetime="2021-04-11T06:32:54.000Z" itemprop="datePublished">2021-04-11</time>
</a>

</div>
<div class="article-inner">


<header class="article-header">
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/04/11/CORS-review/">CORS 复习</a>
    </h1>
  
</header>

<div class="article-entry" itemprop="articleBody">
<p>好久没有更新了，主要是<del>工作忙</del>懒。正好前两天给同事开发 API 的时候，遇见一个小问题，这里简单记录一下。</p>
<p>故事是这样的，我明明给他开启了 CORS （已设置响应头，正确处理 preflight options request），但是对方从本地开发环境访问仍说 CORS 错误。因为这个 API 启用了 Windows 认证，我让他设置 <a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/withCredentials" target="_blank" rel="noopener">withCredentials:true</a>，也没有用，一直报错 401 或 405：</p>
<p><img src="/images/CORS-review/401_unauthorized.jpg" alt="401 Unauthorized"><br><img src="/images/CORS-review/405_method_not_allowed.jpg" alt="405 Method Not Allowed"></p>
<p>明明是复制粘贴之前能正常工作的代码，怎么就不行了？</p>
<p>好吧，按照 <a href="https://docs.microsoft.com/en-us/aspnet/web-api/overview/security/enabling-cross-origin-requests-in-web-api" target="_blank" rel="noopener">官方推荐做法</a> 再来一遍：</p>
<ol>
<li>安装 NuGet 包： <code>Install-Package Microsoft.AspNet.WebApi.Cors</code></li>
<li>启用 CORS，在 <em>App_Start/WebApiConfig.cs</em> 文件新增如下代码：<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cors = <span class="keyword">new</span> System.Web.Http.Cors.EnableCorsAttribute</span><br><span class="line">  (</span><br><span class="line">      Constants.LocalDevEnv,</span><br><span class="line">      <span class="string">"*"</span>,</span><br><span class="line">      <span class="string">"*"</span></span><br><span class="line">  );</span><br><span class="line">cors.SupportsCredentials = <span class="literal">true</span>;</span><br><span class="line">config.EnableCors(cors);</span><br></pre></td></tr></table></figure></li>
<li>接收 preflight request，在<em>web.config</em>文件&lt;system.webServer&gt;&lt;handlers&gt;节点添加以下内容(一般安装 NuGet 包时自动添加)：<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">system.webServer</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">handlers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">remove</span> <span class="attr">name</span>=<span class="string">"ExtensionlessUrlHandler-Integrated-4.0"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">remove</span> <span class="attr">name</span>=<span class="string">"OPTIONSVerbHandler"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">"ExtensionlessUrlHandler-Integrated-4.0"</span> <span class="attr">path</span>=<span class="string">"*."</span> <span class="attr">verb</span>=<span class="string">"*"</span> <span class="attr">type</span>=<span class="string">"System.Web.Handlers.TransferRequestHandler"</span> <span class="attr">preCondition</span>=<span class="string">"integratedMode,runtimeVersionv4.0"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">handlers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">system.webServer</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>设置响应头，在 <em>web.config</em>文件&lt;system.webServer&gt;&lt;httpProtocol&gt;&lt;customHeaders&gt;节点添加以下内容：<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">"Access-Control-Allow-Origin"</span> <span class="attr">value</span>=<span class="string">"http://localhost:3000"</span> /&gt;</span>  <span class="comment">&lt;!-- set the origin specifically--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">"Access-Control-Allow-Headers"</span> <span class="attr">value</span>=<span class="string">"*"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">"Access-Control-Allow-Methods"</span> <span class="attr">value</span>=<span class="string">"*"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">"Access-Control-Allow-Credentials"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>值得注意的是，因为我们启用了 Windows 认证，也就是说，跨域的时候需要设置正确的响应头，否则浏览器依然会报错：</p>
<blockquote>
<p>If the browser sends credentials, but the response does not include a valid Access-Control-Allow-Credentials header, the browser will not expose the response to the application, and the AJAX request fails. Be careful about setting SupportsCredentials to true, because it means a website at another domain can send a logged-in user’s credentials to your Web API on the user’s behalf, without the user being aware. The CORS spec also states that setting origins to “*” is invalid if SupportsCredentials is true.</p>
</blockquote>
<p>简单来说，当 API 需要发送 credentials 给 API 服务器时，<code>Access-Control-Allow-Origin</code> 不能为 <code>*</code>，必须得指明 Origin。</p>
<p>再次测试：</p>
<p><img src="/images/CORS-review/test.png" alt="测试结果"></p>
<p>Bingo！</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul>
<li><a href="https://docs.microsoft.com/en-us/aspnet/web-api/overview/security/enabling-cross-origin-requests-in-web-api" target="_blank" rel="noopener">Enable cross-origin requests in ASP.NET Web API 2</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Glossary/CORS" target="_blank" rel="noopener">CORS</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Credentials" target="_blank" rel="noopener">Access-Control-Allow-Credentials</a></li>
</ul>

</div>
<footer class="article-footer">
<a data-url="https://zxs66.github.io/2021/04/11/CORS-review/" data-id="cla8bpvm4000l9j8c0dnw9vvg" data-title="CORS 复习" class="article-share-link">分享</a>


  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cors/" rel="tag">cors</a></li></ul>

</footer>
</div>

</article>



<article id="post-MySQL-variables" class="article article-type-post" itemscope itemprop="blogPost">
<div class="article-meta">
<a href="/2021/03/25/MySQL-variables/" class="article-date">
  <time datetime="2021-03-25T14:42:51.000Z" itemprop="datePublished">2021-03-25</time>
</a>

</div>
<div class="article-inner">


<header class="article-header">
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/25/MySQL-variables/">MySQL 变量</a>
    </h1>
  
</header>

<div class="article-entry" itemprop="articleBody">
<p>本文仅记录 MySQL 中本地变量和用户变量的相同和不同。</p>
<h3 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR;"></a>TL;DR;</h3><p>感觉英文还行的看官，请直接移步 <a href="#参考链接">参考链接</a> 查看 MySQL 官方文档。</p>
<h5 id="相同点："><a href="#相同点：" class="headerlink" title="相同点："></a>相同点：</h5><p>都可以使用 SET 语句赋值。</p>
<h5 id="不同点"><a href="#不同点" class="headerlink" title="不同点"></a>不同点</h5><table>
<thead>
<tr>
<th></th>
<th>本地变量</th>
<th>用户变量</th>
</tr>
</thead>
<tbody><tr>
<td>变量名称格式</td>
<td>不以@开头</td>
<td>必须以@开头</td>
</tr>
<tr>
<td>是否需要DECLARE</td>
<td>✔️</td>
<td>❌</td>
</tr>
<tr>
<td>常见使用场景</td>
<td>存储过程</td>
<td>即时查询窗口</td>
</tr>
<tr>
<td>存在作用域</td>
<td>当前存储过程</td>
<td>当前会话</td>
</tr>
</tbody></table>
<blockquote>
<p>The scope of a local variable is the BEGIN … END block within which it is declared. The variable can be referred to in blocks nested within the declaring block, except those blocks that declare a variable with the same name. Because local variables are in scope only during stored program execution, references to them are not permitted in prepared statements created within a stored program. Prepared statement scope is the current session, not the stored program, so the statement could be executed after the program ends, at which point the variables would no longer be in scope. For example, SELECT … INTO local_var cannot be used as a prepared statement. </p>
</blockquote>
<blockquote>
<p>User-defined variables are session specific. A user variable defined by one client cannot be seen or used by other clients. (Exception: A user with access to the Performance Schema user_variables_by_thread table can see all user variables for all sessions.) All variables for a given client session are automatically freed when that client exits.</p>
</blockquote>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/user-variables.html" target="_blank" rel="noopener">MySQL::User-Defined Variables</a></li>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/local-variable-scope.html" target="_blank" rel="noopener">MySQL::Local Variable Scope and Resolution</a></li>
<li><a href="https://www.delftstack.com/howto/mysql/mysql-declare-variable/" target="_blank" rel="noopener">Declare and Use Variables in MySQL</a></li>
</ul>

</div>
<footer class="article-footer">
<a data-url="https://zxs66.github.io/2021/03/25/MySQL-variables/" data-id="cla8bpvma000y9j8cddvi6t6x" data-title="MySQL 变量" class="article-share-link">分享</a>


  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/variable/" rel="tag">variable</a></li></ul>

</footer>
</div>

</article>



<article id="post-ASP-NET-MVC-Forms-Authentication" class="article article-type-post" itemscope itemprop="blogPost">
<div class="article-meta">
<a href="/2021/03/14/ASP-NET-MVC-Forms-Authentication/" class="article-date">
  <time datetime="2021-03-14T02:24:00.000Z" itemprop="datePublished">2021-03-14</time>
</a>

</div>
<div class="article-inner">


<header class="article-header">
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/14/ASP-NET-MVC-Forms-Authentication/">ASP.NET MVC 表单认证</a>
    </h1>
  
</header>

<div class="article-entry" itemprop="articleBody">
<p>开始之前，先发一句牢骚，平时我们用微软技术栈（<code>ASP.NET</code>、<code>C#</code>、<code>.NET Core</code>），就是因为看中了绝大多数公司办公环境是 <code>Windows</code> 桌面系统，使用微软技术栈能够更好的与 <code>OA</code>、<code>SMTP</code> 邮箱、<code>ERP</code> 等企业内部系统深度集成。省去了用户权限设计不说（和其他系统共用一个 AD 域账户），还能方便开发者快速搭建原型。所以，我之前编写的 <code>ASP.NET</code> 网站基本上都是使用的 <code>Windows</code> 认证。然而，前几天某客户 IT 的标准要求，不能使用 <code>Windows</code> 认证。具体来说，不是不能使用 <code>Windows</code> 认证，是不能使用各浏览器自带的用户权限输入框来填写用户名密码。我们写的 APP 必须有自己的登陆/登出页面，同时为了使用 AD 域账户，我们的 APP 拿到用户名和<strong>密码</strong>后去 AD 里验证合法性。当时听到这个整个，心中一百个 CNM 在奔腾。你们真的确定吗？？？</p>
<p>先不说这个标准是谁定的，脑子瓦塌了？你真的放心让我来接触域账户密码(明文)？！我自己都害怕。。。不担心我私自存储用户密码？不担心用户填写信息时候被窃听？至少你使用 <code>SSO</code> （Single-Sign On，单点登录）都比这个强啊！</p>
<h3 id="更改-web-config"><a href="#更改-web-config" class="headerlink" title="更改 web.config"></a>更改 web.config</h3><p>打开目标站点的 <code>web.config</code> 文件，更新 <code>authentication</code> 和 <code>authorization</code> 节点配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">system.web</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">httpCookies</span> <span class="attr">requireSSL</span>=<span class="string">"true"</span> <span class="attr">httpOnlyCookies</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">authentication</span> <span class="attr">mode</span>=<span class="string">"Forms"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">forms</span> <span class="attr">name</span>=<span class="string">"at"</span> <span class="attr">requireSSL</span>=<span class="string">"true"</span> <span class="attr">loginUrl</span>=<span class="string">"~/v3/Home/Login"</span> <span class="attr">slidingExpiration</span>=<span class="string">"true"</span> <span class="attr">timeout</span>=<span class="string">"32"</span> <span class="attr">defaultUrl</span>=<span class="string">"/v3/app/en/index.html"</span> <span class="attr">path</span>=<span class="string">"/v3"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">forms</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">authentication</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">authorization</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">deny</span> <span class="attr">users</span>=<span class="string">"?"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">authorization</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">system.web</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="更改-IIS-配置"><a href="#更改-IIS-配置" class="headerlink" title="更改 IIS 配置"></a>更改 IIS 配置</h3><p>运行 <code>inetmgr</code> 命令，进入 IIS，选中需要更改的目标站点，点击认证（Authentication），启用匿名认证（Anonymous Authentication）和表单认证（Forms Authentication）,禁用其他认证方式（如 Windows 认证、Basic 认证等等）。</p>
<h3 id="更新相关代码"><a href="#更新相关代码" class="headerlink" title="更新相关代码"></a>更新相关代码</h3><p>新建/打开 <code>Views/Home/Login.cshtml</code> 文件，更新代码如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">@&#123;</span><br><span class="line">    Layout = null;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Please login<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-id">#login-form</span> &#123;</span></span><br><span class="line">            width: 16em;</span><br><span class="line">            margin: 0 auto;</span><br><span class="line">            padding: 1em;</span><br><span class="line"><span class="css">            <span class="selector-tag">box-shadow</span>: 0 0 0<span class="selector-class">.5em</span> 0<span class="selector-class">.125em</span> <span class="selector-tag">gray</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">            <span class="selector-id">#login-form</span> <span class="selector-tag">img</span> &#123;</span></span><br><span class="line">                width: 4em;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">            <span class="selector-id">#login-form</span> <span class="selector-tag">h2</span> &#123;</span></span><br><span class="line">                text-align: center;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">            <span class="selector-id">#login-form</span> <span class="selector-tag">fieldset</span> &#123;</span></span><br><span class="line">                border: none;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">            <span class="selector-id">#login-form</span> <span class="selector-tag">input</span> &#123;</span></span><br><span class="line">                width: 100%;</span><br><span class="line">                box-sizing: border-box;</span><br><span class="line">                border: none;</span><br><span class="line">                border-bottom: 1px solid gray;</span><br><span class="line">                outline: none;</span><br><span class="line"><span class="css">                <span class="selector-tag">font-size</span>: 1<span class="selector-class">.125em</span>;</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">                <span class="selector-id">#login-form</span> <span class="selector-tag">input</span><span class="selector-attr">[type=submit]</span> &#123;</span></span><br><span class="line">                    border: none;</span><br><span class="line">                    background-color: skyblue;</span><br><span class="line">                    color: white;</span><br><span class="line">                    cursor: pointer;</span><br><span class="line"><span class="css">                    <span class="selector-tag">padding</span>: 0<span class="selector-class">.5em</span>;</span></span><br><span class="line">                    font-size: 1em;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">            <span class="selector-id">#login-form</span> <span class="selector-tag">footer</span> &#123;</span></span><br><span class="line">                text-align: center;</span><br><span class="line">            &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"login-form"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>XXXX Platform<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        @using (Html.BeginForm("Login", "Home", FormMethod.Post))</span><br><span class="line">        &#123;</span><br><span class="line">            @Html.AntiForgeryToken()</span><br><span class="line">            <span class="tag">&lt;<span class="name">fieldset</span>&gt;</span> Login <span class="tag">&lt;/<span class="name">fieldset</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">placeholder</span>=<span class="string">"user name"</span> <span class="attr">required</span> <span class="attr">maxlength</span>=<span class="string">"16"</span> <span class="attr">minlength</span>=<span class="string">"4"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">placeholder</span>=<span class="string">"password"</span> <span class="attr">required</span> <span class="attr">maxlength</span>=<span class="string">"32"</span> <span class="attr">minlength</span>=<span class="string">"10"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"ts"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"→ LOGIN"</span> /&gt;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">footer</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>Copyright <span class="symbol">&amp;copy;</span> XXXX @(DateTime.Now.Year)<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">footer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.forms[<span class="number">0</span>].addEventListener(<span class="string">'submit'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.forms[<span class="number">0</span>].ts.value = <span class="built_in">Date</span>.now();</span></span><br><span class="line">        &#125;);</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>新建/打开 <code>Controllers/HomeController.cs</code>，更新代码如下：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> default controller</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HomeController</span> : <span class="title">Controller</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> default action for HomeController</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ActionResult <span class="title">Index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ViewBag.Title = <span class="string">"Home Page"</span>;</span><br><span class="line">        <span class="keyword">return</span> View();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> browse login page</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    [<span class="meta">AllowAnonymous</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ActionResult <span class="title">Login</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (User.Identity != <span class="literal">null</span> &amp;&amp; User.Identity.IsAuthenticated)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// user already logged in</span></span><br><span class="line">            <span class="keyword">this</span>.clearUserState();</span><br><span class="line">            <span class="comment">// return Redirect(FormsAuthentication.DefaultUrl);</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> View();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> authenticate user with Authorization header</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    [<span class="meta">HttpPost,ValidateAntiForgeryToken</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ActionResult <span class="title">Login</span>(<span class="params">LoginFormData form</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// login form validation</span></span><br><span class="line">        <span class="keyword">if</span> (form == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationException(<span class="string">"empty login form"</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrWhiteSpace(form.username))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationException(<span class="string">$"empty <span class="subst">&#123;<span class="keyword">nameof</span>(form.username)&#125;</span>"</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrWhiteSpace(form.password))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationException(<span class="string">$"empty <span class="subst">&#123;<span class="keyword">nameof</span>(form.password)&#125;</span>"</span>);</span><br><span class="line">        <span class="keyword">if</span> (form.ts == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationException(<span class="string">$"empty <span class="subst">&#123;<span class="keyword">nameof</span>(form.ts)&#125;</span>(timestamp)"</span>);</span><br><span class="line">        <span class="comment">// permit only the characters required and field length necessary </span></span><br><span class="line">        <span class="keyword">if</span> (!System.Text.RegularExpressions.Regex.Match(form.username, <span class="string">@"^[a-zA-Z0-9\-\.]&#123;4,16&#125;$"</span>).Success)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationException(<span class="string">$"invalid <span class="subst">&#123;<span class="keyword">nameof</span>(form.username)&#125;</span>"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!(</span><br><span class="line">            <span class="comment">/* a mimumum of 10 and maximum of 32 characters */</span></span><br><span class="line">            <span class="comment">/* printable characters, including space */</span></span><br><span class="line">            System.Text.RegularExpressions.Regex.Match(form.password, <span class="string">@"^[\s!-~]&#123;10,32&#125;$"</span>).Success</span><br><span class="line">              <span class="comment">/* at least 1 lower case alpha character (A-Z) */</span></span><br><span class="line">              <span class="comment">/* at least 1 upper case alpha character (A-Z) */</span></span><br><span class="line">              <span class="comment">/* at least 1 numberic character(0-9) */</span></span><br><span class="line">              &amp;&amp; System.Text.RegularExpressions.Regex.Match(form.password, <span class="string">@"^(?=.*[a-z]+)(?=.*[A-Z]+)(?=.*[0-9]+)"</span>).Success</span><br><span class="line">            ))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationException(<span class="string">$"invalid <span class="subst">&#123;<span class="keyword">nameof</span>(form.password)&#125;</span>"</span>);</span><br><span class="line">        <span class="comment">// prevent form replay attach</span></span><br><span class="line">        <span class="keyword">long</span> unixTime = ((DateTimeOffset)DateTime.UtcNow).ToUnixTimeSeconds();</span><br><span class="line">        <span class="keyword">if</span> (Math.Abs(unixTime - (form.ts) / <span class="number">1000</span>) &gt; <span class="number">10</span>)</span><br><span class="line">            <span class="comment">// the timestamp gap between client and server is greater than 10 seconds</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationException(<span class="string">"NO Form Replay Attach!!!"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> pCtx = <span class="keyword">new</span> PrincipalContext(ContextType.Domain, Constants.ADDomain))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// validate credential against AD server</span></span><br><span class="line">            <span class="keyword">bool</span> flag = pCtx.ValidateCredentials(form.username, form.password);</span><br><span class="line">            <span class="keyword">if</span> (flag)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// validate successfully</span></span><br><span class="line">                <span class="keyword">var</span> ticket = <span class="keyword">new</span> FormsAuthenticationTicket</span><br><span class="line">                (</span><br><span class="line">                    <span class="number">1</span>,</span><br><span class="line">                    form.username,</span><br><span class="line">                    DateTime.Now,</span><br><span class="line">                    DateTime.Now.AddMinutes(Constants.SessionDurationInMinutes),</span><br><span class="line">                    Constants.CreatePersistentCookie,</span><br><span class="line">                    <span class="string">"salt"</span>,  <span class="comment">// user specified data</span></span><br><span class="line">                    FormsAuthentication.FormsCookiePath</span><br><span class="line">                );</span><br><span class="line">                <span class="keyword">var</span> cookie = <span class="keyword">new</span> HttpCookie(FormsAuthentication.FormsCookieName, FormsAuthentication.Encrypt(ticket))</span><br><span class="line">                &#123;</span><br><span class="line">                    Secure = <span class="literal">true</span>,</span><br><span class="line">                    HttpOnly = <span class="literal">true</span>,</span><br><span class="line">                    Path = ticket.CookiePath</span><br><span class="line">                &#125;;</span><br><span class="line">                Response.Cookies.Add(cookie);</span><br><span class="line">                <span class="comment">// save login ticket</span></span><br><span class="line">                <span class="comment">// to prevent concurrent logins from same user</span></span><br><span class="line">                Biz.Helper.UACHelper.UserLogin(cookie.Value);</span><br><span class="line">                Logger.Info(<span class="string">"Audit Success"</span>, form.username, <span class="keyword">this</span>.Request?.UserHostAddress);   <span class="comment">// success login audit</span></span><br><span class="line">                <span class="keyword">return</span> Redirect(FormsAuthentication.DefaultUrl);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// validate failed</span></span><br><span class="line">                Logger.Info(<span class="string">"Audit Failure"</span>, form.username, <span class="keyword">this</span>.Request?.UserHostAddress);   <span class="comment">// failed login audit</span></span><br><span class="line">                <span class="keyword">return</span> RedirectToAction(<span class="string">"Login"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> logout page</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    [<span class="meta">AllowAnonymous</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ActionResult <span class="title">Logout</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.clearUserState();</span><br><span class="line">        Logger.Info(<span class="string">"logout audit"</span>, <span class="keyword">this</span>.User?.Identity?.Name, <span class="keyword">this</span>.Request?.UserHostAddress);   <span class="comment">// logout audit</span></span><br><span class="line">        <span class="keyword">return</span> View();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearUserState</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        FormsAuthentication.SignOut();</span><br><span class="line">        <span class="comment">// clear authentication cookie</span></span><br><span class="line">        HttpCookie authTokenCookie = <span class="keyword">new</span> HttpCookie(FormsAuthentication.FormsCookieName, <span class="keyword">string</span>.Empty) &#123; Secure = <span class="literal">true</span>, HttpOnly = <span class="literal">true</span> &#125;;</span><br><span class="line">        authTokenCookie.Expires = DateTime.Now.AddYears(<span class="number">-1</span>);</span><br><span class="line">        Response.Cookies.Add(authTokenCookie);</span><br><span class="line">        <span class="comment">// clear session</span></span><br><span class="line">        Session.Clear();</span><br><span class="line">        Session.Abandon();</span><br><span class="line">        <span class="comment">//Session.RemoveAll();</span></span><br><span class="line">        <span class="comment">//HttpContext.User = new System.Security.Principal.GenericPrincipal(new System.Security.Principal.GenericIdentity(string.Empty), null);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h3><ol>
<li>应整改要求，Cookie Path 没有特殊批复，不得设置为根路径(<code>/</code>)，故此处的 Cookie Path 设置为 <code>/v3</code> (所有页面放置于 <code>/v3/app</code> 目录下，API 在 <code>/v3/api</code> 路径下)；</li>
<li>默认开启 Secure 和 HttpOnly 属性，防止 CSRF；</li>
<li>此处示例代码，表面上启用表单验证，其实后台服务器将用户填写的表单发送至服务器的域服务器（AD Server）验证。各位看官可以根据自身实际情况调整；</li>
<li>待调整事项：此处 <code>Login.cshtml</code> 使用了内联脚本。但如果公司启用了严格 CSP，该内联脚本将会被禁用，可考虑移至外部脚本中。</li>
</ol>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul>
<li><a href="https://docs.microsoft.com/en-us/troubleshoot/aspnet/forms-based-authentication" target="_blank" rel="noopener">Implement forms-based authentication in an ASP.NET application by using C#.NET</a></li>
<li><a href="https://www.c-sharpcorner.com/UploadFile/fa9d0d/forms-authentication-in-Asp-Net/" target="_blank" rel="noopener">Forms Authentication In ASP.NET</a></li>
</ul>

</div>
<footer class="article-footer">
<a data-url="https://zxs66.github.io/2021/03/14/ASP-NET-MVC-Forms-Authentication/" data-id="cla8bpvly00079j8c41be368y" data-title="ASP.NET MVC 表单认证" class="article-share-link">分享</a>


  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/asp-net/" rel="tag">asp.net</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/forms-authentication/" rel="tag">forms authentication</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mvc/" rel="tag">mvc</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/windows-authentication/" rel="tag">windows authentication</a></li></ul>

</footer>
</div>

</article>




<nav id="page-nav">

<a class="extend prev" rel="prev" href="/page/11/">&lt; 上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><a class="page-number" href="/page/14/">14</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><a class="extend next" rel="next" href="/page/13/">下一页 &gt;</a>
</nav>

<style>
.article {max-height: 123vh;overflow: hidden;position: relative;}
.article.unfold {max-height: initial;}
.article .more {position: absolute;bottom: 0;padding: 3em;cursor: pointer;text-align: center;width: 100%;background: linear-gradient(rgba(0, 0, 0, 0), silver);color: white;box-sizing: border-box;}
.article.unfold .more {display: none;}
</style>
<script>
(function () {
// show more
const moreText = '<i class="fa fa-arrow-circle-down" aria-hidden="true"></i> ' + "更多";
const articles = document.getElementsByClassName('article');
for (let i = 0; i < articles.length; i++) {
const $more = document.createElement('div');
$more.classList.add('more');$more.innerHTML = moreText;
$more.onclick = function (evt) {
const $src = evt.target || evt.srcElement;$src.parentElement.classList.add('unfold');
};
articles[i].appendChild($more);
}})();
</script>
</section>

</div>
<footer id="footer">

<div class="outer"><div id="footer-info" class="inner">&copy; 2022 时代残党<br>
Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></div>
</div></footer>
</div>
<nav id="mobile-nav">

<a href="/" class="mobile-nav-link">home</a>

<a href="/archives" class="mobile-nav-link">archives</a>

<a href="/app" class="mobile-nav-link">contact</a>

</nav>
<!--

<script src="https://cdn.bootcdn.net/ajax/libs/jquery/2.0.3/jquery.min.js" crossorigin="anonymous" integrity="sha256-pXtSQrmprcTB74RsNlFHuJxHK5zXcPrOMx78uWU0ayU&#x3D; sha384-ECTndYny330R2jlSXBiZkdXzAVi0Z&#x2F;iDXJTwV6cp39HECmalqg6+b2sFZFf&#x2F;Y2m6 sha512-epzJ9ms+0Pq+zFMrG1lXVNvjEXgtfKx9iuEWqz3hmbaU2m&#x2F;Dp1pcmpYzuSdDLqX6PMIjzMOyGFwMc+SkgFhMFg&#x3D;&#x3D;"></script>

-->

<script src="/js/script.js" async></script>

</div>
<script>
(function () {
// append image-caption
const images = document.querySelectorAll('article img');
for (let j = 0; j < images.length; j++) {
const $img = images[j];
const altText = $img.getAttribute('alt');
if (altText && altText.length && !$img.classList.contains('inline')) {
const $imgCaption = document.createElement('div');
$imgCaption.classList.add('img-caption');
$imgCaption.innerText = $img.getAttribute('alt');
$img.parentNode.insertBefore($imgCaption, $img.nextSibling);
}}})();
</script>
</body></html>