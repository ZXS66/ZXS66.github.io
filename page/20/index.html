<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<title>时代残党</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<link rel="icon" href="/favicon.png">
<meta property="og:type" content="website">
<meta property="og:title" content="时代残党">
<meta property="og:url" content="https://zxs66.github.io/page/20/">
<meta property="og:site_name" content="时代残党">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="时代残党">
<meta property="article:tag" content="C#">
<meta property="article:tag" content="Angular">
<meta property="article:tag" content="NodeJS">
<meta property="article:tag" content="SQL">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="ASP.NET">
<meta property="article:tag" content="Full Stack">
<meta name="twitter:card" content="summary">
<link rel="dns-prefetch" href="https://cdn.bootcdn.net/">
<link rel="dns-prefetch" href="https://fonts.googleapis.com/">
<link rel="dns-prefetch" href="https://fonts.gstatic.com/">
<meta name="baidu-site-verification" content="1W34rVIdAO" />

<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" crossorigin="anonymous" integrity="sha256-eZrrJcwDc&#x2F;3uDhsdt61sL2oOBY362qM3lon1gyExkL0&#x3D; sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN sha512-SfTiTlX6kk+qitfevl&#x2F;7LibUOeJWlt9rbyDn92a1DqWOw9vWG2MFoays0sgObmWazO5BQPiFucnnEAjpAB+&#x2F;Sw&#x3D;&#x3D;">


<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro" />


<link rel="stylesheet" href="/css/style.css">

<link rel="manifest" href="/manifest.json">
<script type="module" src="/pwabuilder-sw-register.js"></script>
<!-- 百度统计 -->
<script>
var _hmt = _hmt || [];
(function () {
var hm = document.createElement("script");
hm.src = "https://hm.baidu.com/hm.js?de1c4b02a9f8a51a6001797e045d3af9";
var s = document.getElementsByTagName("script")[0];
s.parentNode.insertBefore(hm, s);
})();
</script>
</head><body>
<div id="container">
<div id="wrap">
<header id="header">
<div id="banner"></div>
<div id="header-outer" class="outer">
<div id="header-title" class="inner">
<h1 id="logo-wrap">
<a href="/" id="logo">时代残党</a>
</h1>

<h2 id="subtitle-wrap">
<a href="/" id="subtitle">随手笔记</a>
</h2>

</div>
<div id="header-inner" class="inner">
<nav id="main-nav">
<a id="main-nav-toggle" class="nav-icon"></a>

<a class="main-nav-link" href="/">首页</a>

<a class="main-nav-link" href="/archives">归档</a>

<a class="main-nav-link" href="/app">联系我</a>

</nav>
<div id="search-form-wrap">
<div class="search-form"><input type="search" name="wd" class="search-form-input" placeholder="Search" list="search-datalist" autocomplete="false"/></div>

<input type="hidden" id="search-index-file" value="/search.json" />
<div id="search-form-datalist"></div>

</div>
<nav id="sub-nav">

<a id="nav-search-btn" class="nav-icon" title="搜索"></a>
</nav>
</div>
</div>
</header>
<div class="outer">
<section id="main">


<article id="post-CDN-failover" class="article article-type-post" itemscope itemprop="blogPost">
<div class="article-meta">
<a href="/2020/07/23/CDN-failover/" class="article-date">
  <time datetime="2020-07-23T06:49:22.000Z" itemprop="datePublished">2020-07-23</time>
</a>

</div>
<div class="article-inner">


<header class="article-header">
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/23/CDN-failover/">CDN 故障转移</a>
    </h1>
  
</header>

<div class="article-entry" itemprop="articleBody">
<p>首先说一句，这篇文章标题可能不太准确，因为涉及的技能点可能有点杂，比较跳跃，但是都是我在做 CDN 故障转移时碰到的，所以全都扔在一篇文章里，不介意的话，将就着吧，有什么不懂的，请点击文章中的各种链接 😄</p>
<p>这篇文章是继上篇文章 <a href="/2020/07/19/reliable-CDN/">可靠 CDN</a> 之后的另一篇关于 CDN 的思考及实践。</p>
<h2 id="SRI-检查"><a href="#SRI-检查" class="headerlink" title="SRI 检查"></a>SRI 检查</h2><p><a href="https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity" target="_blank" rel="noopener">SRI</a> 是一种安全机制，让浏览器通过验证它接收到的资源（比如从 CDN）是未经过更改的。简单理解就是浏览器把（从 CDN）拿到的资源进行哈希计算，然后把这个哈希值与开发者事先计算好的哈希值（integrity) 匹配。目前<a href="https://caniuse.com/#feat=subresource-integrity" target="_blank" rel="noopener">大多数浏览器都支持 SRI 检查</a>(emmm，除了 IE)。 </p>
<p>实际使用很简单，就是指定 <code>script</code> 或 <code>link</code> 标签的 <code>integrity</code> 属性，值为事先计算的该静态资源的哈希值（sha256，sha384，sha512中的一个或多个） <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity#Using_Subresource_Integrity" target="_blank" rel="noopener"><fa-link/></a>。MDN 推荐了一个 <a href="https://www.srihash.org/" target="_blank" rel="noopener">SRI Hash Generator</a> <em>（有一个缺点，只能生成 script 便签，不能根据 css 文件成 link 标签，需要手动调整）</em></p>
<p>需要注意的是，一般需要 SRI 检查的静态资源都在 CDN 上，所以都是需要开启 CORS。好在 CDN 默认都开启了，我们需要做的是浏览器端手动添加上 <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/CORS_settings_attributes" target="_blank" rel="noopener">crossorigin 属性</a>，不然可能会出错 :(</p>
<h2 id="标记-script-标签为-async-或-defer"><a href="#标记-script-标签为-async-或-defer" class="headerlink" title="标记 script 标签为 async 或 defer"></a>标记 script 标签为 async 或 defer</h2><p>下面是 <code>script</code> 标签的属性（<code>async</code>、<code>defer</code>、<code>module</code>、<code>nomodule</code>等）常用场景 <a href="https://gist.github.com/jakub-g/385ee6b41085303a53ad92c7c8afd7a6" target="_blank" rel="noopener"><fa-link/></a>：</p>
<table>
<thead>
<tr>
<th><code>script</code>标签类型</th>
<th>常见使用场景</th>
</tr>
</thead>
<tbody><tr>
<td>script src</td>
<td>a legacy library that is needed by subsequent inline scripts</td>
</tr>
<tr>
<td>script src defer</td>
<td>deferred execution, maintaining order; e.g. a lib that is needed by other defer scripts; progressive enhancement code</td>
</tr>
<tr>
<td>script src async</td>
<td>deferred execution, without order (independent scripts); e.g. self-instantiating analytics lib</td>
</tr>
<tr>
<td>script src async defer</td>
<td>like above, but with IE9 support</td>
</tr>
<tr>
<td>script inline</td>
<td>1) small piece of code that must be executed immediately, before some subsequent code (inlined polyfills, timers, server-generated configuration), or to register certain event listeners as soon as possible; 2) non-cacheable (generated, often changing etc.) code; 3) experience critical code that is small and the round-trip latency to download it separately would be too much</td>
</tr>
<tr>
<td>script src module</td>
<td>library/app, for modern browsers only</td>
</tr>
<tr>
<td>script src module async</td>
<td>progressive enhancement code, for modern browsers only</td>
</tr>
<tr>
<td>script inline module</td>
<td>small piece of and/or non-cacheable code, for modern browsers only; perhaps inline config that is necessary for another non-async module declared after it</td>
</tr>
<tr>
<td>script inline module async</td>
<td>small piece of and/or non-cacheable progressive enhancement code (independent script), for modern browsers only; it may <code>import</code>s a well-cacheable library</td>
</tr>
<tr>
<td>script nomodule …</td>
<td>a fallback script for legacy browsers, when shipping ES modules to modern browsers</td>
</tr>
</tbody></table>
<p>简略版的请看图：</p>
<p><img src="/images/cdn-failover/a%20comparison%20of%20various%20ways%20the%20script%20tags%20in%20HTML.png" alt="A comparison of various ways the script tags in HTML"></p>
<p>总结：<strong>一般情况下，<code>async</code> 用于加载基础类库（加载完立即执行，无依赖项），<code>defer</code> 用于加载一些 addon（待基础类库加载完后，<code>DOMContentLoaded</code> 事件前，依次执行）</strong>。</p>
<h2 id="调整-Hexo-模板生成脚本"><a href="#调整-Hexo-模板生成脚本" class="headerlink" title="调整 Hexo 模板生成脚本"></a>调整 Hexo 模板生成脚本</h2><h5 id="增加-CDN-配置项"><a href="#增加-CDN-配置项" class="headerlink" title="增加 CDN 配置项"></a>增加 CDN 配置项</h5><p>👇 _config.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cdn:</span> <span class="string">https://cdn.bootcdn.net/ajax/libs/</span></span><br></pre></td></tr></table></figure>

<h5 id="使用-Hexo-默认的-helper-方法-js-css-生成-script-link-标签。"><a href="#使用-Hexo-默认的-helper-方法-js-css-生成-script-link-标签。" class="headerlink" title="使用 Hexo 默认的 helper 方法 js/css 生成 script/link 标签。"></a>使用 <a href="https://hexo.io/docs/helpers.html" target="_blank" rel="noopener">Hexo 默认的 helper 方法</a> js/css 生成 script/link 标签。</h5><p>👇 after-footer.ejs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;%- js(&#123;src:config.cdn+&#39;jquery&#x2F;2.0.3&#x2F;jquery.min&#39;,integrity:&#39;sha256-pXtSQrmprcTB74RsNlFHuJxHK5zXcPrOMx78uWU0ayU&#x3D; sha384-ECTndYny330R2jlSXBiZkdXzAVi0Z&#x2F;iDXJTwV6cp39HECmalqg6+b2sFZFf&#x2F;Y2m6 sha512-epzJ9ms+0Pq+zFMrG1lXVNvjEXgtfKx9iuEWqz3hmbaU2m&#x2F;Dp1pcmpYzuSdDLqX6PMIjzMOyGFwMc+SkgFhMFg&#x3D;&#x3D;&#39;,crossorigin:&#39;anonymous&#39;&#125;) %&gt;</span><br><span class="line">&lt;% if (theme.fancybox)&#123; %&gt;</span><br><span class="line">&lt;%- css(&#123;href:config.cdn+&#39;fancybox&#x2F;2.1.5&#x2F;jquery.fancybox.min&#39;,integrity:&#39;sha384-RMsmRsuFJAxdvCCX2XHjTlWajoB7207PpLqA4HMVuie0TAWK0x+7ubbuDa58Tcij&#39;,crossorigin:&#39;anonymous&#39;&#125;) %&gt;</span><br><span class="line">&lt;%- js(&#123;src:config.cdn+&#39;fancybox&#x2F;2.1.5&#x2F;jquery.fancybox.pack&#39;,integrity:&#39;sha384-A&#x2F;Tc8RFHsjkPvgL0yZebgTxxmCGCSaTpGkyQLeFFFJQIAzSozLwNGX9AOCIpxoXC&#39;,crossorigin:&#39;anonymous&#39;,defer:true&#125;) %&gt;</span><br><span class="line">&lt;% &#125; %&gt;</span><br><span class="line">&lt;%- js(&#123;src:&#39;js&#x2F;script&#39;,defer:true&#125;) %&gt;</span><br></pre></td></tr></table></figure>

<h5 id="编写自定义-Hexo-Helper-方法-Optional"><a href="#编写自定义-Hexo-Helper-方法-Optional" class="headerlink" title="编写自定义 Hexo Helper 方法 (Optional)"></a>编写自定义 Hexo Helper 方法 (<em>Optional</em>)</h5><p>Hexo 默认的 helper 方法 <code>js</code> 和 <code>css</code> 足够使用，但是还有精简的空间。比如每个方法的参数均包含 <code>config.cdn</code> 和 <code>crossorigin:&#39;anonymous&#39;</code>，一个程序员的基本素养就是 DRY (Don’t Repeat Yourself)。以下就是其中一种优化措施 （<a href="https://hexo.io/api/helper.html" target="_blank" rel="noopener">参考链接</a>）：</p>
<p>在 <code>theme/your-theme/scripts</code> 下新建 <code>js_cdn.js</code> 和 <code>css_cdn.js</code> 文件。其中前者内容如下（后者内容极其相似）：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">hexo.extend.helper.register(<span class="string">"js_cdn"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> js = hexo.extend.helper.get(<span class="string">"js"</span>).bind(hexo);</span><br><span class="line">  <span class="keyword">const</span> integrityProp = <span class="string">"integrity"</span>;</span><br><span class="line">  <span class="keyword">const</span> placeholder = <span class="string">" "</span> + integrityProp;</span><br><span class="line">  <span class="keyword">const</span> crossoriginAttr = <span class="string">' crossorigin="anonymous"'</span>;</span><br><span class="line">  <span class="keyword">let</span> markup = js(item);</span><br><span class="line">  <span class="keyword">if</span> (item.hasOwnProperty(integrityProp)) &#123;</span><br><span class="line">    <span class="comment">// default `js` helper function doesn't include crossorigin="anonymous" in the generated script markup</span></span><br><span class="line">    <span class="keyword">const</span> idx = markup.indexOf(placeholder);</span><br><span class="line">    markup = [markup.substring(<span class="number">0</span>, idx), crossoriginAttr, markup.substring(idx)].join(<span class="string">""</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> markup;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>更新模板生成脚本 <code>after-footer.ejs</code> (删除 <code>,crossorigin:&#39;anonymous&#39;</code>)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;%- js_cdn(&#123;src:config.cdn+&#39;jquery&#x2F;2.0.3&#x2F;jquery.min&#39;,integrity:&#39;sha256-pXtSQrmprcTB74RsNlFHuJxHK5zXcPrOMx78uWU0ayU&#x3D; sha384-ECTndYny330R2jlSXBiZkdXzAVi0Z&#x2F;iDXJTwV6cp39HECmalqg6+b2sFZFf&#x2F;Y2m6 sha512-epzJ9ms+0Pq+zFMrG1lXVNvjEXgtfKx9iuEWqz3hmbaU2m&#x2F;Dp1pcmpYzuSdDLqX6PMIjzMOyGFwMc+SkgFhMFg&#x3D;&#x3D;&#39;&#125;) %&gt;</span><br><span class="line">&lt;% if (theme.fancybox)&#123; %&gt;</span><br><span class="line">&lt;%- css_cdn(&#123;href:config.cdn+&#39;fancybox&#x2F;2.1.5&#x2F;jquery.fancybox.min&#39;,integrity:&#39;sha384-RMsmRsuFJAxdvCCX2XHjTlWajoB7207PpLqA4HMVuie0TAWK0x+7ubbuDa58Tcij&#39;&#125;) %&gt;</span><br><span class="line">&lt;%- js_cdn(&#123;src:config.cdn+&#39;fancybox&#x2F;2.1.5&#x2F;jquery.fancybox.pack&#39;,integrity:&#39;sha384-A&#x2F;Tc8RFHsjkPvgL0yZebgTxxmCGCSaTpGkyQLeFFFJQIAzSozLwNGX9AOCIpxoXC&#39;,defer:true&#125;) %&gt;</span><br><span class="line">&lt;% &#125; %&gt;</span><br><span class="line">&lt;%- js_cdn(&#123;src:&#39;js&#x2F;script&#39;,defer:true&#125;) %&gt;</span><br></pre></td></tr></table></figure>

<h2 id="CDN-故障转移"><a href="#CDN-故障转移" class="headerlink" title="CDN 故障转移"></a>CDN 故障转移</h2><p>进入本文正文了！</p>
<p>考虑到 CDN 也有会有打盹的时候，所以，一个比较好的实践就是时刻做好 Plan B。我的方法是，在页面的自定义脚本中检查脚本加载情况并在执行尝试加载候选资源。</p>
<p>以下是示例代码（<code>js/script.js</code>）：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> dependencies = [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">export</span>: <span class="built_in">window</span>.jQuery,</span><br><span class="line">      failover: <span class="string">"https://ajax.aspnetcdn.com/ajax/jQuery/jquery-2.0.3.min.js"</span>,</span><br><span class="line">      <span class="comment">// failover: "https://code.jquery.com/jquery-2.0.3.min.js",</span></span><br><span class="line">      integrity: <span class="string">"sha256-sTy1mJ4I/LAjFCCdEB4RAvPSmRCb3CU7YqodohyeOLo="</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">export</span>: (<span class="built_in">window</span>.jQuery || &#123;&#125;).fancybox,</span><br><span class="line">      failover:</span><br><span class="line">        <span class="string">"https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.pack.js"</span>,</span><br><span class="line">      integrity:</span><br><span class="line">        <span class="string">"sha384-A/Tc8RFHsjkPvgL0yZebgTxxmCGCSaTpGkyQLeFFFJQIAzSozLwNGX9AOCIpxoXC"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ];</span><br><span class="line">  <span class="comment">// failover to load alternative files when CDN libraries failed.</span></span><br><span class="line">  <span class="keyword">var</span> nonLoadedDependencies = dependencies.filter(<span class="function"><span class="keyword">function</span>(<span class="params">dep</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> !dep.export;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">/** lazy load js files */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">loadDependency</span>(<span class="params">dep</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">"script"</span>);</span><br><span class="line">      script.src = dep.failover;</span><br><span class="line">      <span class="keyword">if</span> (dep.integrity &amp;&amp; dep.integrity.length) &#123;</span><br><span class="line">        script.integrity = dep.integrity;</span><br><span class="line">        script.crossOrigin = <span class="string">"anonymous"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// // https://www.html5rocks.com/en/tutorials/speed/script-loading/#toc-dom-rescue</span></span><br><span class="line">      script.async = <span class="literal">false</span>;</span><br><span class="line">      script.addEventListener(<span class="string">"load"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        resolve(dep.failover + <span class="string">" is loaded"</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">      script.addEventListener(<span class="string">"error"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        reject(dep.failover + <span class="string">" can't be loaded!"</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="built_in">document</span>.body.appendChild(script);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  (nonLoadedDependencies.length</span><br><span class="line">    ? <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">Promise</span>.all(nonLoadedDependencies.map(loadDependency)).then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">          resolve(<span class="string">"All dependencies are loaded!"</span>);</span><br><span class="line">        &#125;, reject);</span><br><span class="line">      &#125;)</span><br><span class="line">    : <span class="built_in">Promise</span>.resolve(<span class="string">"All dependencies are loaded!"</span>)</span><br><span class="line">  ).then(myBiz);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** business logic, will be executed when all dependencies loaded */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">myBiz</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">/// your business code comes here</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>其中有一行语句需要单独拎出来讲一下的，就是上面脚本的第 31 行，<code>script.async = false;</code></p>
<p>如果您的 <code>dependencies</code> 都没有依赖项，有没有这条语句关系不大，相反还能提高加载性能。但是，现实情况是很多脚本都是有依赖项的，上面贴的代码就是个很好的例子。<code>jquery.fancybox.pack.js</code> 文件依赖于 <code>jquery.min.js</code> 文件。</p>
<p>所以，如果没有这行语句，默认这些 <code>script</code> 会按 <code>async</code> 的方式去执行（脚本下载成功立即执行），也就是说，可能会出现后面的脚本先被执行的情况。但是后面的脚本依赖于前面的脚本，立即执行会报错。</p>
<p><img src="/images/cdn-failover/dependent%20script%20execution%20error.png" alt=""></p>
<p>受 <a href="https://www.html5rocks.com/en/tutorials/speed/script-loading/" target="_blank" rel="noopener">这篇文章</a> 启发，加上上面说的这条语句，就可以确保 async 的脚本的执行顺序了。</p>
<p>调整完之后的脚本下载时间不变，但是不报错了，因为执行顺序对上了。</p>
<p><img src="/images/cdn-failover/async%20script%20execution%20order.png" alt=""></p>
<p>当然，这个脚本还有很大的提升空间（比如，<code>Promise</code> 在低版本浏览器兼容问题），这里暂时就不浪费体力了。</p>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>既然动态添加的 <code>async</code> 脚本执行顺序不确定，那 <code>defer</code> 脚本如何呢？？</p>
<h2 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a>参考链接：</h2><ul>
<li><a href="https://gist.github.com/jakub-g/385ee6b41085303a53ad92c7c8afd7a6" target="_blank" rel="noopener">&lt;script&gt; async, defer, async defer, module, nomodule, src, inline - the cheat sheet</a></li>
<li><a href="https://javascript.info/script-async-defer" target="_blank" rel="noopener">Scripts: async, defer</a></li>
</ul>

</div>
<footer class="article-footer">
<a data-url="https://zxs66.github.io/2020/07/23/CDN-failover/" data-id="clbs21ii6000go48c5sn98aqu" data-title="CDN 故障转移" class="article-share-link">分享</a>


  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/async/" rel="tag">async</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cdn/" rel="tag">cdn</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/defer/" rel="tag">defer</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/execution-order/" rel="tag">execution order</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/failover/" rel="tag">failover</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/" rel="tag">javascript</a></li></ul>

</footer>
</div>

</article>



<article id="post-reliable-CDN" class="article article-type-post" itemscope itemprop="blogPost">
<div class="article-meta">
<a href="/2020/07/19/reliable-CDN/" class="article-date">
  <time datetime="2020-07-19T07:40:45.000Z" itemprop="datePublished">2020-07-19</time>
</a>

</div>
<div class="article-inner">


<header class="article-header">
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/19/reliable-CDN/">可靠 CDN</a>
    </h1>
  
</header>

<div class="article-entry" itemprop="articleBody">
<p>前几天，把博客的 <a href="https://fontawesome.com/" target="_blank" rel="noopener">font-awesome</a> 引用从博客站点本身切换到 CDN。图省事，就用了以前国内外通用的 <a href="https://www.cloudflare.com/zh-cn/network/china/" target="_blank" rel="noopener">cloudflare</a>，因为之前不管是在公司（外网），还是在家里（国内），访问都挺快的。然后，就出事了。。。</p>
<p>今天在家，闲来没事，打开自己的博客，发现 font-awesome 加载不了。起初，我以为是浏览器问题，因为我用 Firefox 有时候能正常渲染 icon font，过一会儿刷新一下又不能了，但是我用 Chrome 一直都可以正常工作。</p>
<p>去网上搜索一圈，发现 MDN 说：</p>
<blockquote>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" target="_blank" rel="noopener"><i class="fa fa-link" aria-hidden="true"></i></a> Web Fonts (for cross-domain font usage in @font-face within CSS), so that servers can deploy TrueType fonts that can only be cross-site loaded and used by web sites that are permitted to do so. </p>
</blockquote>
<blockquote>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy" target="_blank" rel="noopener"><i class="fa fa-link" aria-hidden="true"></i></a> Fonts applied with @font-face. Some browsers allow cross-origin fonts, others require same-origin. </p>
</blockquote>
<p>发生跨域了？废话，用 CDN 肯定要跨域啊。但这些应该都是正常操作，Chrome 都行。emmm，Firefox 你在作妖吗。MDN 说的 others，该不会说的就是它自己吧。。。</p>
<p>查证一下 <a href="https://caniuse.com/#feat=fontface" target="_blank" rel="noopener">Can I use</a>：</p>
<p><img src="/images/reliable-cdn/caniuse%20font%20face%20web%20fonts.jpg" alt=""></p>
<p>只要服务器支持 CORS 浏览器就没问题！<a href="http://cssbakery.com/2010/07/fixing-firefox-font-face-cross-domain_25.html" target="_blank" rel="noopener">这篇文章</a> 遇到的问题也是这样。</p>
<p>不会吧，CDN 不支持 CORS 那 CDN 要怎么用，cloudflare 肯定是支持 CORS 的！</p>
<p>再回头对比一下，我发现是 Firefox 请求字体文件出错时，发送的请求，是不带 HTTP 版本号的。</p>
<p><img src="/images/reliable-cdn/firefox%20cert%20invalid.jpg" alt="firefox 请求字体文件不带版本号"></p>
<p>而正常请求是指定了 HTTP 版本号的：</p>
<p><img src="/images/reliable-cdn/firefox%20working.jpg" alt="firefox 正常请求字体"></p>
<p>但是偶然又有一次带了版本号依然无法请求资源</p>
<p><img src="/images/reliable-cdn/firefox%20cert%20invalid%204.jpg" alt="firefox 请求字体文件不带版本号"></p>
<p>什么鬼，你耍我？ <img src="/images/reliable-cdn/questions.png" alt="？？？"> </p>
<p>莫非，真的是 CDN 问题？我查查…</p>
<p>好家伙，还真有问题！<a href="https://segmentfault.com/a/1190000023290310" target="_blank" rel="noopener">Cloudflare DNS 服务中断，大量网站和服务无法访问</a> </p>
<p>虽然文中并未提及国内是否受波及，但为什么我受影响了？我去 <a href="https://www.cloudflarestatus.com/" target="_blank" rel="noopener">官网</a> 看看。官网说了</p>
<blockquote>
<p>All Systems Operational</p>
</blockquote>
<p>所有节点均正常？你确定？然后，我发现，7月17号，也就是前天有一个 incident</p>
<blockquote>
<h2 id="Cloudflare-Network-and-Resolver-Issues"><a href="#Cloudflare-Network-and-Resolver-Issues" class="headerlink" title="Cloudflare Network and Resolver Issues"></a>Cloudflare Network and Resolver Issues</h2><p>Resolved - This incident has been resolved.<br>Jul 17, 22:57 UTC<br>Monitoring - A fix has been implemented and we are monitoring the results.<br>Jul 17, 22:34 UTC<br>Update - This afternoon we saw an outage across some parts of our network. It was not as a result of an attack. It appears a router on our global backbone announced bad routes and caused some portions of the network to not be available. We believe we have addressed the root cause and are monitoring systems for stability now.<br>Jul 17, 22:09 UTC</p>
</blockquote>
<p>嘶<del>~</del> 有点不靠谱的感觉。没人攻击您，后台路由出问题了？</p>
<p>稍等，我之前好像看见，cloudflare 国内是和百度云合作的？嘶<del>~</del> （不吹不黑，只是个人不喜欢太商业化的东西）</p>
<p>拜拜咯，cloudflare！下载一个 js 和 css 文件都这么慢，还不如直接使用自己站点资源 🤦‍</p>
<p><img src="/images/reliable-cdn/firefox%20cert%20invalid%202.jpg" alt="firefox 请求 css 文件"><br><img src="/images/reliable-cdn/firefox%20cert%20invalid%203.jpg" alt="firefox 请求 js 文件"></p>
<p>既然不用 cloudflare，那换谁呢？简单搜索了一下，目前看起来，bootcdn 还不错，行，安排！！</p>
<p>刷刷刷，搞定！</p>
<p>firefox 打开，正常！</p>

</div>
<footer class="article-footer">
<a data-url="https://zxs66.github.io/2020/07/19/reliable-CDN/" data-id="clbs21ik4008qo48c8kg77ino" data-title="可靠 CDN" class="article-share-link">分享</a>


  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/baidu/" rel="tag">baidu</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cdn/" rel="tag">cdn</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cloudflare/" rel="tag">cloudflare</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/firefox/" rel="tag">firefox</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iconfont/" rel="tag">iconfont</a></li></ul>

</footer>
</div>

</article>



<article id="post-get-started-with-Flutter" class="article article-type-post" itemscope itemprop="blogPost">
<div class="article-meta">
<a href="/2020/07/18/get-started-with-Flutter/" class="article-date">
  <time datetime="2020-07-18T07:10:21.000Z" itemprop="datePublished">2020-07-18</time>
</a>

</div>
<div class="article-inner">


<header class="article-header">
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/18/get-started-with-Flutter/">Flutter 入门</a>
    </h1>
  
</header>

<div class="article-entry" itemprop="articleBody">
<h2 id="为什么要学-Flutter？"><a href="#为什么要学-Flutter？" class="headerlink" title="为什么要学 Flutter？"></a>为什么要学 Flutter？</h2><ul>
<li>提升技能。移动端 skillset √ ，全栈开发 √</li>
<li>Flutter 是趋势。“<em>Google 出品，必是精品！</em>”</li>
<li>React Native 不感冒</li>
</ul>
<h2 id="网站"><a href="#网站" class="headerlink" title="网站"></a>网站</h2><ul>
<li><a href="https://flutter.dev/" target="_blank" rel="noopener">Flutter</a> <em>【Flutter 官网】</em></li>
<li><a href="https://flutter.cn/" target="_blank" rel="noopener">Flutter 中文社区</a> <em>【Flutter 官网（中文）】</em></li>
<li><a href="https://dart.cn/guides/language/language-tour" target="_blank" rel="noopener">Dart 开发语言概览</a> <em>【1小时入门 Dart】</em></li>
<li><a href="https://codelabs.flutter-io.cn/" target="_blank" rel="noopener">Flutter Codelabs</a> <em>【更多入门案例】</em></li>
<li><a href="https://www.yuque.com/xytech/flutter/aqsvov" target="_blank" rel="noopener">重磅|庖丁解牛之——Flutter for Web · 语雀</a> <em>【咸鱼出品】</em></li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>因为本来就打算尝试 Flutter for Web，而此功能目前还处于 beta 分支，所以下载 <code>xxxx-stable.zip</code> 安装包基本没用，最终还是需要切换分支，重新更新。所以，以下是我的安装方法：</p>
<h5 id="1-从-GitHub-上下载最新-beta-分支-git-clone"><a href="#1-从-GitHub-上下载最新-beta-分支-git-clone" class="headerlink" title="1. 从 GitHub 上下载最新 beta 分支 (git clone)"></a>1. 从 GitHub 上下载最新 beta 分支 (git clone)</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/flutter/flutter.git -b beta</span><br></pre></td></tr></table></figure>

<h5 id="2-更新环境变量"><a href="#2-更新环境变量" class="headerlink" title="2. 更新环境变量 "></a>2. 更新环境变量 <a href="https://flutter.cn/docs/get-started/install/windows" target="_blank" rel="noopener"><fa-link/></a></h5><p>将 <code>flutter\bin</code> 添加至环境变量 <code>PATH</code>。Linux 和 Mac 用户命令行搞定：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export PATH="$PWD/flutter/bin:$PATH"</span><br></pre></td></tr></table></figure>

<p>Windows 用户可以选择鼠标点点，更改环境变量 （我的电脑-&gt;属性-&gt;高级系统设置-&gt;环境变量-&gt;用户变量）</p>
<h5 id="3-配置-flutter-使用镜像站点"><a href="#3-配置-flutter-使用镜像站点" class="headerlink" title="3. 配置 flutter 使用镜像站点 "></a>3. 配置 flutter 使用镜像站点 <a href="https://flutter.cn/docs/get-started/install/windows" target="_blank" rel="noopener"><fa-link/></a></h5><p>Flutter 官方站点 (<a href="https://flutter.dev" target="_blank" rel="noopener">https://flutter.dev</a>) 是在境外，被小镇禁止访问了，所以，此步骤是小镇用户需要做的额外操作。</p>
<p>类似于第二步，不同的是，这一步更改的是 <code>PUB_HOSTED_URL</code> 和 <code>FLUTTER_STORAGE_BASE_URL</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export PUB_HOSTED_URL=https://pub.flutter-io.cn</span><br><span class="line">export FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn</span><br></pre></td></tr></table></figure>

<p>当然，Flutter 镜像站点，除了 Flutter 中文社区 <code>flutter-io.cn</code> 这一个，还有另外两个，如果觉得这个主站点慢，可以随时切换：</p>
<ul>
<li>上海交通大学软件源镜像服务</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export FLUTTER_STORAGE_BASE_URL: https://mirrors.sjtug.sjtu.edu.cn/</span><br><span class="line">export PUB_HOSTED_URL: https://dart-pub.mirrors.sjtug.sjtu.edu.cn/</span><br></pre></td></tr></table></figure>

<ul>
<li>清华大学开源软件镜像站</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export FLUTTER_STORAGE_BASE_URL: https://mirrors.tuna.tsinghua.edu.cn/flutter</span><br><span class="line">export PUB_HOSTED_URL: https://mirrors.tuna.tsinghua.edu.cn/dart-pub</span><br></pre></td></tr></table></figure>

<h5 id="4-初始化"><a href="#4-初始化" class="headerlink" title="4. 初始化 "></a>4. 初始化 <a href="https://flutter.cn/docs/get-started/web" target="_blank" rel="noopener"><fa-link/></a></h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flutter channel beta</span><br><span class="line">flutter upgrade</span><br><span class="line">flutter config --enable-web</span><br></pre></td></tr></table></figure>
<p><em>备注：初始化过程中，可能会遇到下载失败问题，这时候可以参照第三步骤，切换镜像站点，并检查您此时的网络链接是否可以访问到镜像站点</em></p>
<h5 id="5-验证安装"><a href="#5-验证安装" class="headerlink" title="5. 验证安装 "></a>5. 验证安装 <a href="https://flutter.cn/docs/get-started/web" target="_blank" rel="noopener"><fa-link/></a></h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flutter devices</span><br><span class="line">flutter doctor</span><br></pre></td></tr></table></figure>

<p><img src="/images/flutter/flutter%20doctor%20no%20issues%20found.jpg" alt="install successfully"></p>
<p>如果 <code>flutter devices</code> 书出一个名为 Chrome 的设备信息，则表示所有的安装、配置均完成。</p>
<h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello, World! "></a>Hello, World! <a href="https://flutter.cn/docs/get-started/web" target="_blank" rel="noopener"><fa-link/></a></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flutter create testflutter</span><br><span class="line">cd testflutter</span><br><span class="line">flutter run -d chrome --web-hostname=127.0.0.1</span><br></pre></td></tr></table></figure>

<p>打开 Chrome 浏览器，访问站点</p>
<p><img src="/images/flutter/flutter%20run.png" alt="flutter run -d chrome --web-hostname=127.0.0.1"></p>
<h2 id="编译、部署"><a href="#编译、部署" class="headerlink" title="编译、部署 "></a>编译、部署 <a href="https://flutter.cn/docs/deployment/web" target="_blank" rel="noopener"><fa-link/></a></h2><p>编译：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flutter build web</span><br></pre></td></tr></table></figure>

<p>部署：随便找个站点挂挂，本地的，或者云上的。</p>
<p><img src="/images/flutter/flutter%20build%20web.png" alt="flutter build web"></p>
<p>🎉🎉🎉 完美，算是迈出了第一步了！接下来就是找个练手项目，积攒经验值了。</p>

</div>
<footer class="article-footer">
<a data-url="https://zxs66.github.io/2020/07/18/get-started-with-Flutter/" data-id="clbs21iio001vo48cb7cshiuf" data-title="Flutter 入门" class="article-share-link">分享</a>


  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flutter/" rel="tag">flutter</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/get-started/" rel="tag">get started</a></li></ul>

</footer>
</div>

</article>




<nav id="page-nav">

<a class="extend prev" rel="prev" href="/page/19/">&lt; 上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="page-number" href="/page/19/">19</a><span class="page-number current">20</span><a class="page-number" href="/page/21/">21</a><a class="page-number" href="/page/22/">22</a><a class="page-number" href="/page/23/">23</a><a class="extend next" rel="next" href="/page/21/">下一页 &gt;</a>
</nav>

<style>
.article {max-height: 123vh;overflow: hidden;position: relative;}
.article.unfold {max-height: initial;}
.article .more {position: absolute;bottom: 0;padding: 3em;cursor: pointer;text-align: center;width: 100%;background: linear-gradient(rgba(0, 0, 0, 0), silver);color: white;box-sizing: border-box;}
.article.unfold .more {display: none;}
</style>
<script>
(function () {
// show more
const moreText = '<i class="fa fa-arrow-circle-down" aria-hidden="true"></i> ' + "更多";
const articles = document.getElementsByClassName('article');
for (let i = 0; i < articles.length; i++) {
const $more = document.createElement('div');
$more.classList.add('more');$more.innerHTML = moreText;
$more.onclick = function (evt) {
const $src = evt.target || evt.srcElement;$src.parentElement.classList.add('unfold');
};
articles[i].appendChild($more);
}})();
</script>
</section>

</div>
<footer id="footer">

<div class="outer"><div id="footer-info" class="inner">&copy; 2022 时代残党<br>
Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></div>
</div></footer>
</div>
<nav id="mobile-nav">

<a href="/" class="mobile-nav-link">home</a>

<a href="/archives" class="mobile-nav-link">archives</a>

<a href="/app" class="mobile-nav-link">contact</a>

</nav>
<!--

<script src="https://cdn.bootcdn.net/ajax/libs/jquery/2.0.3/jquery.min.js" crossorigin="anonymous" integrity="sha256-pXtSQrmprcTB74RsNlFHuJxHK5zXcPrOMx78uWU0ayU&#x3D; sha384-ECTndYny330R2jlSXBiZkdXzAVi0Z&#x2F;iDXJTwV6cp39HECmalqg6+b2sFZFf&#x2F;Y2m6 sha512-epzJ9ms+0Pq+zFMrG1lXVNvjEXgtfKx9iuEWqz3hmbaU2m&#x2F;Dp1pcmpYzuSdDLqX6PMIjzMOyGFwMc+SkgFhMFg&#x3D;&#x3D;"></script>

-->

<script src="/js/script.js" async></script>

</div>
<script>
(function () {
// append image-caption
const images = document.querySelectorAll('article img');
for (let j = 0; j < images.length; j++) {
const $img = images[j];
const altText = $img.getAttribute('alt');
if (altText && altText.length && !$img.classList.contains('inline')) {
const $imgCaption = document.createElement('div');
$imgCaption.classList.add('img-caption');
$imgCaption.innerText = $img.getAttribute('alt');
$img.parentNode.insertBefore($imgCaption, $img.nextSibling);
}}})();
</script>
</body></html>