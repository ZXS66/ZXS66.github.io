<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<title>译：从代码中发帖至 WordPress.com | 时代残党</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<link rel="icon" href="/favicon.png">
<meta name="description" content="各位中秋&amp;国庆节日快乐~ Jon Skeet 大神更新博客啦！作为 C# 专家、Stackoverflow 排名第一的神一样的人物，自然是订阅的啦。正好放假，闲来无事，不如把这篇文章翻译一下，正好加深理解。 🙂 声明：如果各位英文够用，请移步原文，本文仅仅是随笔，英文捉急的朋友可自由食用。 正文开始：  历史我从 2005 年开始写博客，也就是在我打算参加唯一的 MVP 大会 (Micr">
<meta property="og:type" content="article">
<meta property="og:title" content="译：从代码中发帖至 WordPress.com">
<meta property="og:url" content="https://zxs66.github.io/2020/10/01/translate-POSTING-TO-WORDPRESS-COM-IN-CODE/">
<meta property="og:site_name" content="时代残党">
<meta property="og:description" content="各位中秋&amp;国庆节日快乐~ Jon Skeet 大神更新博客啦！作为 C# 专家、Stackoverflow 排名第一的神一样的人物，自然是订阅的啦。正好放假，闲来无事，不如把这篇文章翻译一下，正好加深理解。 🙂 声明：如果各位英文够用，请移步原文，本文仅仅是随笔，英文捉急的朋友可自由食用。 正文开始：  历史我从 2005 年开始写博客，也就是在我打算参加唯一的 MVP 大会 (Micr">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-10-01T13:04:08.000Z">
<meta property="article:modified_time" content="2022-11-08T14:11:27.203Z">
<meta property="article:author" content="时代残党">
<meta property="article:tag" content="随笔">
<meta property="article:tag" content="c#">
<meta property="article:tag" content="translate">
<meta property="article:tag" content="wordpress">
<meta property="article:tag" content="blog">
<meta name="twitter:card" content="summary">
<link rel="dns-prefetch" href="https://cdn.bootcdn.net/">
<link rel="dns-prefetch" href="https://fonts.googleapis.com/">
<link rel="dns-prefetch" href="https://fonts.gstatic.com/">
<meta name="baidu-site-verification" content="1W34rVIdAO" />

<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" crossorigin="anonymous" integrity="sha256-eZrrJcwDc&#x2F;3uDhsdt61sL2oOBY362qM3lon1gyExkL0&#x3D; sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN sha512-SfTiTlX6kk+qitfevl&#x2F;7LibUOeJWlt9rbyDn92a1DqWOw9vWG2MFoays0sgObmWazO5BQPiFucnnEAjpAB+&#x2F;Sw&#x3D;&#x3D;">


<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro" />


<link rel="stylesheet" href="/css/style.css">

<link rel="manifest" href="/manifest.json">
<script type="module" src="/pwabuilder-sw-register.js"></script>
<!-- 百度统计 -->
<script>
var _hmt = _hmt || [];
(function () {
var hm = document.createElement("script");
hm.src = "https://hm.baidu.com/hm.js?de1c4b02a9f8a51a6001797e045d3af9";
var s = document.getElementsByTagName("script")[0];
s.parentNode.insertBefore(hm, s);
})();
</script>
</head><body>
<div id="container">
<div id="wrap">
<header id="header">
<div id="banner"></div>
<div id="header-outer" class="outer">
<div id="header-title" class="inner">
<h1 id="logo-wrap">
<a href="/" id="logo">时代残党</a>
</h1>

<h2 id="subtitle-wrap">
<a href="/" id="subtitle">随手笔记</a>
</h2>

</div>
<div id="header-inner" class="inner">
<nav id="main-nav">
<a id="main-nav-toggle" class="nav-icon"></a>

<a class="main-nav-link" href="/">首页</a>

<a class="main-nav-link" href="/archives">归档</a>

<a class="main-nav-link" href="/app">联系我</a>

</nav>
<div id="search-form-wrap">
<div class="search-form"><input type="search" name="wd" class="search-form-input" placeholder="Search" list="search-datalist" autocomplete="false"/></div>

<input type="hidden" id="search-index-file" value="/search.json" />
<div id="search-form-datalist"></div>

</div>
<nav id="sub-nav">

<a id="nav-search-btn" class="nav-icon" title="搜索"></a>
</nav>
</div>
</div>
</header>
<div class="outer">
<section id="main">
<article id="post-translate-POSTING-TO-WORDPRESS-COM-IN-CODE" class="article article-type-post" itemscope itemprop="blogPost">
<div class="article-meta">
<a href="/2020/10/01/translate-POSTING-TO-WORDPRESS-COM-IN-CODE/" class="article-date">
  <time datetime="2020-10-01T13:04:08.000Z" itemprop="datePublished">2020-10-01</time>
</a>

</div>
<div class="article-inner">


<header class="article-header">
  
    <h1 class="article-title" itemprop="name">
      译：从代码中发帖至 WordPress.com
    </h1>
  
</header>

<div class="article-entry" itemprop="articleBody">
<p>各位中秋&amp;国庆节日快乐~</p>
<p><a href="https://codeblog.jonskeet.uk" target="_blank" rel="noopener">Jon Skeet</a> 大神更新博客啦！作为 C# 专家、Stackoverflow 排名第一的神一样的人物，自然是订阅的啦。正好放假，闲来无事，不如把这篇文章翻译一下，正好加深理解。 🙂</p>
<p>声明：如果各位英文够用，请移步<a href="https://codeblog.jonskeet.uk/2020/08/29/1793/" target="_blank" rel="noopener">原文</a>，本文仅仅是随笔，英文捉急的朋友可自由食用。</p>
<p>正文开始：</p>
<hr>
<h2 id="历史"><a href="#历史" class="headerlink" title="历史"></a>历史</h2><p>我从 2005 年开始写博客，也就是在我打算参加唯一的 <a href="https://mvp.microsoft.com/en-us/Summit" target="_blank" rel="noopener">MVP 大会</a> (Microsoft Most Valuble Professional Summit) 前不久。彼时，我把博客托管在 msmvps.com，那还是个很大的事情。</p>
<p>2014 年，我迁移到 wordpress.com 了，期望这会让事情变得美好、简单：它是个专注于博客托管的服务，因此我不应担心写作之外的事情。 事情没有这么简单。</p>
<p>我不记得我是什么时候开始使用 Markdown 来书写博客来取代使用 Windows Live Writer 创建 HTML，但是这绝对是我更喜欢的书写方式。我可以把它 <em>（译者：Markdown）</em> 的格式用到任何地方，它让发布代码变得更简单…它就是正确的格式（对于我而言）。</p>
<p>我在 wordpresscom 遇到的几乎所有问题都可以分为两类：</p>
<ul>
<li>WordPress 的 Markdown 并未按照我期望的方式运行。</li>
<li>wordpress.com 的编辑器对 Markdown 用户不友好。</li>
</ul>
<p>第一类，有两个问题。第一，我对于代码以外的换行感到烦恼。我喜欢书写段落的时候包括换行，这样文本可以可以基本上维持 80 - 100 字符每行。不幸的是，WordPress 和 GitHub 都将这种段落格式转换成多个短行，而不是一整个段落。我不知道为什么做这个决定，格式化成这样的，我可以看到 <em>一些</em> 场景下这样的处理确实有益处（比如“添加一个单词”的变动仅仅显示这一个变动，而不是所有当前段落的改动）。尽管如此，我还是不喜欢这个决定。</p>
<p>第二个令人烦恼的是代码中的尖括号（使用代码栅栏 &#96;&#96;&#96; 或反引号 &#96;）在 WordPress 中表现不可预期，以一种我不记得在其他哪个地方见过的方式。最常见的不得不更新文章的原因是我需要去修复一些 C# 代码中的泛型，摆弄 Markdown 以转义括号。最近这些天，我可能会试着记录这点，这样的话将来发表文章的时候可以正确使用它。总而言之，这肯定会让人很挫败。</p>
<p>我并不期望能够解决所有的问题，我也许可以通过某些形式的预处理来处理这些文章，但我担心只有非 <em>（尖括号）</em> 包围的段落而非代码块才能够变得这么快。没关系，我可以和这些问题共存。</p>
<p>第二种烦恼，在 wordpress.com 上编辑，正式本篇所要讲的大部分内容。</p>
<p>我严重怀疑大部分博主想要一个合理的所见即所得（<code>WYSIWYG</code>, What you see is what you get）体验，并且他们肯定不想以未格式化的原始格式（通常是 HTML，但对于我而言是 Markdown）看他们的博客。我记得很久之前，wordpress.com 的编辑器有两种模式：图形的和文本的。在某些情况下，图形编辑器可以转换 Markdown 为 HTML，进而显示在文本编辑器中…它只需要保留纯文本。我的习惯是保留一份文章备份的文本（最开始是在 <a href="https://stackedit.io/" target="_blank" rel="noopener">StackEdit</a> 但现在是在 <a href="https://github.com" target="_blank" rel="noopener">GitHub</a>），然后当我想要编辑东西的时候，复制全部到 WordPress 中。这样我不需要关心 WordPress 如何工作的。</p>
<p>然而，现在 wordpress.com 让这个工作流更加复杂了，他们切换到一个“块”编辑器，以一种简易的界面方式，且你只能通过管理员界面才能得到这个文本编辑器。</p>
<p>我觉得这真的是够了。如果我本地拿到这边文章的时候是以文本形式（然后存在 GitHub 上），完全没有必要去 wordpress.com 界面上去做除了评论之外的任何其他事情。是时候破解他们的 API 了。</p>
<h2 id="什么是无-NET-包？"><a href="#什么是无-NET-包？" class="headerlink" title="什么是无 .NET 包？"></a>什么是无 .NET 包？</h2><p>WordPress 是一个非常通用的博客平台，让我们接受它。我完全不奇怪它有一个 REST API 允许你去发表文章（我之前使用 StackEdit 多年的事实就是一个很好的证明）。我也不奇怪它使用 OAuth2 来认证，判定 OAuth 的异常。</p>
<p>我好奇的是，我不能找到任何 .NET 包来写一个控制台应用程序来调用仅包含极简代码的 API。我甚至不能找到任何简单的适用于控制台应用程序而非 web 应用程序的 OAuth 库。 <a href="https://restsharp.dev/" target="_blank" rel="noopener">RestSharp</a> 看起来像他承诺的那样，就像他的首页所说：“支持 Basic, OAuth 1, OAuth 2, JWT, NTLM”，但是 <a href="https://restsharp.dev/usage/authenticators.html" target="_blank" rel="noopener">这篇认证文档</a> 仅能够做有限的事情。看他们的源码，它除了启动一个本地的 web 服务器以接收 OAuth 代码，然后用于交换完整的认证令牌之外，并未做任何其它的事情（我知道并不多的 OAuth 2，但是足够我在查看一些库源码的时候明白缺少了什么）。<a href="看起来">WordPressPCL</a>也像他承诺的那样，但是依赖 JWT 认证插件，我不想仅仅是为了安装一个简单的插件从 wordpress.com 个人账户升级商业账户（我知道它可能还有其他的好处，但……）。</p>
<p>因此，我有如下选项：</p>
<ul>
<li>升级到商业账户，安装 JWT 插件，然后尝试使用 WordPressPCL</li>
<li>完全远离 wordpress.com，自行运行 WordPress（或者找另一个类 wordpress.com 站点，我猜）并让 JWT 插件可用，然后再使用 WordPressPCL</li>
<li>自行实现 OAuth2</li>
</ul>
<h2 id="自托管-WordPress"><a href="#自托管-WordPress" class="headerlink" title="自托管 WordPress"></a>自托管 WordPress</h2><p>我很乐意自己运行 WordPress。我有一个 <a href="https://cloud.google.com/kubernetes-engine" target="_blank" rel="noopener">Google Kubernetes Engine</a> 群，用来托管 <a href="https://nodatime.org/" target="_blank" rel="noopener">nodatetime.org</a> 和其他的站点。我到现在才看明白，在 Kubernetes 群中安装 WordPress 会非常简单。有一个 <a href="https://bitnami.com/stacks/helm" target="_blank" rel="noopener">Bitnami Helm Chart</a> 正好合适，因此我决定试一试。</p>
<p>首先我必须安装 Helm，我听说过它，但从未使用过。我第一次尝试使用 shell 脚本，失败了……但用 Chocolatey，安装成功。</p>
<p>安装 WordPress 轻而易举，直到它出错，因为我的 Kubernetes 群没有足够的可用资源。它是个很小的群，当然，它并不用于商业，是我个人掏钱付的，因此我尝试保持花销相对较低。显然它太低了。</p>
<p>我调查了一下我大概需要花费多少来提高我的 Kubernetes 群的能力以自主运行 WordPress，最后我得出结论，这个比我开一个 wordpress.com 商业账户还要贵（甚至在我运维这个站点之前），我决定停止继续往前。</p>
<h2 id="实现-OAuth2"><a href="#实现-OAuth2" class="headerlink" title="实现 OAuth2"></a>实现 OAuth2</h2><p>最后，我不应该这么害怕自行实现 OAuth2。它并没有那么坏，特别是当我需要一个新的 token 时我喜欢通过一些手动步骤来实现，而不是全自动。</p>
<p>首先我必须在 wordpress.com 上创建一个“应用”。这个仅仅是一个注册，为了拿到用于 OAuth 的 <code>client_secret</code>、<code>client_id</code> 和批准的重定向 URI。我知道我正在本地运行服务，因此我允许 <a href="http://127.0.0.1:8080/auth" target="_blank" rel="noopener">http://127.0.0.1:8080/auth</a> 作为重定向 URI，并相应的创建此应用。</p>
<p>基本流程如下：</p>
<ul>
<li>启动本地 web 服务器，接收来自 WordPress 服务器的重定向响应</li>
<li>在浏览器中访问一个精心构建的 URL</li>
<li>在浏览器中授权访问</li>
<li>WordPress 响应并重定向到本地服务器，包含一个 <code>code</code></li>
<li>本地服务器发起另一个 HTTP 请求到 WordPress 服务器，以交换 <code>code</code> 获取 <code>token</code></li>
<li>本地服务器显示此 <code>token</code> 这样我可以复制粘贴到其他地方使用</li>
</ul>
<p>当然，在一个正常的应用中，用户从不需要看见 <code>token</code>，这所有的一切都发生在背后。然而，在我最终的“调用 WordPress API 创建或更新文章的控制台应用程序”中执行此操作，比起复制、粘贴并硬编码 token 更加麻烦。这个代码安全吗，它是否被偷窃过？当然没有。我能接受这个风险吗？当然！</p>
<p>因此，最简单的方式是在一个独立的应用中启动 HTTP 服务器（我不需要它和其他东西集成）？你当然可以创建一个新的空 ASP.NET Core 应用，找到合适的地方处理请求…但我个人更喜欢使用 <a href="https://github.com/GoogleCloudPlatform/functions-framework-dotnet" target="_blank" rel="noopener">.NET Functions 框架</a>。作为框架的作者，我显然存在偏见，但我很高兴看到在实际工作中使用它是如此简单。解决方案非常简单，使用 <code>dotnet new gcf-http</code> 命令创建一个单 C# 文件和项目文件。这个 C# 文件包含一个类（<code>Function</code>）和一个函数 （<code>HandleAsync</code>），总共 50 行代码。</p>
<p>提醒你，它仍需要花费超过一小时以获取可正常创建 WordPress 文章的 token。是因为表单 URL 编码太复杂吗？不，尽管我的调查使我朝这个方向前进。是因为发出请求时需要对 token 进行 base64 编码吗？不是的，尽管 <em>（我的）</em> 很多尝试也是在这条路上。</p>
<p>我犯了两个错误：</p>
<ul>
<li>在我的 <em>交换 code 以换取 token 的服务器</em> 上，我在交换请求时，我把 <code>redirect_uri</code> 填写成 “<a href="http://127.0.0.1/auth”" target="_blank" rel="noopener">http://127.0.0.1/auth”</a> 而不是 “<a href="http://127.0.0.1:8080/auth”" target="_blank" rel="noopener">http://127.0.0.1:8080/auth”</a></li>
<li>在 <em>测试 token 的应用</em> 中，我在 <code>AuthenticationHeaderValue</code> 中指定 schema 为 “Basic” 而不是 “Bearer” </li>
</ul>
<p>基本上全是拼写错误。难以置信的沮丧，但我确实在这里犯错了。</p>
<p>我有一个有趣的想法，现在我不是有一个 Function 可以做 OAuth 吗，那为什么我不将之部署成一个真的 Google Cloud Function 呢，这样我可以随时通过访问一个 URL 获取 <code>token</code> 而不需要本地运行任何程序。我只需要一点点的配置，当然 ASP.NET Core 已经让这一点做起来很容易了，不需要我们来做。</p>
<h2 id="发表文章至-WordPress"><a href="#发表文章至-WordPress" class="headerlink" title="发表文章至 WordPress"></a>发表文章至 WordPress</h2><p>当前，我有一个可以创建 WordPress 文章（以 Markdown 格式，这点非常重要）的测试应用，它也可以更新文章。</p>
<p>下一步是想办法找到我将来发表博客的工作流。考虑到我把博客的资源存储在 GitHub 上，我也许可以通过一个 GitHub 行为来触发代码，但我不确定这是不是一个行之有效的工作流。现在，我要“当我要创建/更新文章时显式运行一个应用”。</p>
<p>现在更新一个文章必须要知道文章 ID，这个我可以通过 WordPress 界面获取，但我也可以在最初创建文章的时候获取。但我需要一个存储它的地方，我可以为这些文章创建一个单独的元数据文件（metadata），但这个听起来像事情往复杂的方向发展的感觉。</p>
<p>取而代之，我目前的解决方案是在文章正文开始添加一点元数据头，这样应用可以读取它并做相应的处理。它也可以在 wordpress.com 上创建文章之后更新成文章 ID。这样也避免我在命令行中不得不指定比如标题这样的信息。在我写这篇文章的时候，这篇文章的元数据头如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">title: Posting to wordpress.com in code</span><br><span class="line">categories: C#, General</span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<p>在我第一次运行我的应用之后，我预计这篇文章将会变成这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">postId: 12345</span><br><span class="line">title: Posting to wordpress.com in code</span><br><span class="line">categories: C#, General</span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<p>下次我让它去处理这个文件的时候，因为有 <code>postId</code> 值的存在，它将触发我的应用去“更新”而不是去“创建”。</p>
<p>这样就行了吗？几分钟之后见分晓。这段代码并未真正运行过。是的，我可以为它编写一些测试。但我就不，我并不打算编写测试。我觉得它很容易通过一些尝试和错误就能看出问题所在（它并不是特别复杂的代码）。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>如果你看到这篇文章，我已经用这个新的流程来发表我的博客了。我绝对不会手动创建这篇文章——如果这个代码不行的话，我是绝对不会让你看到的。</p>
<p>这个流程是其他人想要的吗？可能是，也可能不是。我并未打算开源它。但它是一个很好的范例，通过不大的努力来排解烦恼……我可以享受使用自己的 Function 框架并付诸行动，这对于我来说是个奖励。</p>
<p>该发布了！</p>

</div>
<footer class="article-footer">
<a data-url="https://zxs66.github.io/2020/10/01/translate-POSTING-TO-WORDPRESS-COM-IN-CODE/" data-id="clab8ajtn003j6o8c5noybuqc" data-title="译：从代码中发帖至 WordPress.com" class="article-share-link">分享</a>


  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/blog/" rel="tag">blog</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c/" rel="tag">c#</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/translate/" rel="tag">translate</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wordpress/" rel="tag">wordpress</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%9A%8F%E7%AC%94/" rel="tag">随笔</a></li></ul>

</footer>
</div>

<nav id="article-nav">
  
    <a href="/2020/10/10/react-hooks/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">更新</strong>
      <div class="article-nav-title">
        
          React Hooks 学习笔记
        
      </div>
    </a>
  
  
    <a href="/2020/09/11/get-started-with-WeChat-mini-program/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">更早</strong>
      <div class="article-nav-title">微信小程序入门</div>
    </a>
  
</nav>

</article>


</section>

</div>
<footer id="footer">

<div class="outer"><div id="footer-info" class="inner">&copy; 2022 时代残党<br>
Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></div>
</div></footer>
</div>
<nav id="mobile-nav">

<a href="/" class="mobile-nav-link">home</a>

<a href="/archives" class="mobile-nav-link">archives</a>

<a href="/app" class="mobile-nav-link">contact</a>

</nav>
<!--

<script src="https://cdn.bootcdn.net/ajax/libs/jquery/2.0.3/jquery.min.js" crossorigin="anonymous" integrity="sha256-pXtSQrmprcTB74RsNlFHuJxHK5zXcPrOMx78uWU0ayU&#x3D; sha384-ECTndYny330R2jlSXBiZkdXzAVi0Z&#x2F;iDXJTwV6cp39HECmalqg6+b2sFZFf&#x2F;Y2m6 sha512-epzJ9ms+0Pq+zFMrG1lXVNvjEXgtfKx9iuEWqz3hmbaU2m&#x2F;Dp1pcmpYzuSdDLqX6PMIjzMOyGFwMc+SkgFhMFg&#x3D;&#x3D;"></script>

-->

<script src="/js/script.js" async></script>

</div>
<script>
(function () {
// append image-caption
const images = document.querySelectorAll('article img');
for (let j = 0; j < images.length; j++) {
const $img = images[j];
const altText = $img.getAttribute('alt');
if (altText && altText.length && !$img.classList.contains('inline')) {
const $imgCaption = document.createElement('div');
$imgCaption.classList.add('img-caption');
$imgCaption.innerText = $img.getAttribute('alt');
$img.parentNode.insertBefore($imgCaption, $img.nextSibling);
}}})();
</script>
</body></html>