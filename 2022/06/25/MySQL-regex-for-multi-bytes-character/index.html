<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<title>MySQL 正则表达式支持多字节字符 | 时代残党</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<link rel="icon" href="/favicon.png">
<meta name="description" content="背景最近在工作中遇到一个小问题，就是需要一些简单的字符串匹配，自然而然想到使用正则表达式了。简单搜索了一下，MySQL 中如何使用正则，基本上都介绍用 REGEXP 函数。 但是，这个函数有个限制，在 MySQL 8.0.4 之前的版本，它是按字节匹配的，而不是字符！换句话说，对于汉字或者 Emoji 这样多字节的字符，它不支持！  The REGEXP and RLIKE operators w">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL 正则表达式支持多字节字符">
<meta property="og:url" content="https://zxs66.github.io/2022/06/25/MySQL-regex-for-multi-bytes-character/">
<meta property="og:site_name" content="时代残党">
<meta property="og:description" content="背景最近在工作中遇到一个小问题，就是需要一些简单的字符串匹配，自然而然想到使用正则表达式了。简单搜索了一下，MySQL 中如何使用正则，基本上都介绍用 REGEXP 函数。 但是，这个函数有个限制，在 MySQL 8.0.4 之前的版本，它是按字节匹配的，而不是字符！换句话说，对于汉字或者 Emoji 这样多字节的字符，它不支持！  The REGEXP and RLIKE operators w">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-06-25T09:30:04.000Z">
<meta property="article:modified_time" content="2022-11-08T14:11:27.193Z">
<meta property="article:author" content="时代残党">
<meta property="article:tag" content="mysql">
<meta property="article:tag" content="regex">
<meta property="article:tag" content="multi-bytes">
<meta name="twitter:card" content="summary">
<link rel="dns-prefetch" href="https://cdn.bootcdn.net/">
<link rel="dns-prefetch" href="https://fonts.googleapis.com/">
<link rel="dns-prefetch" href="https://fonts.gstatic.com/">
<meta name="baidu-site-verification" content="1W34rVIdAO" />

<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" crossorigin="anonymous" integrity="sha256-eZrrJcwDc&#x2F;3uDhsdt61sL2oOBY362qM3lon1gyExkL0&#x3D; sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN sha512-SfTiTlX6kk+qitfevl&#x2F;7LibUOeJWlt9rbyDn92a1DqWOw9vWG2MFoays0sgObmWazO5BQPiFucnnEAjpAB+&#x2F;Sw&#x3D;&#x3D;">


<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro" />


<link rel="stylesheet" href="/css/style.css">

<link rel="manifest" href="/manifest.json">
<script type="module" src="/pwabuilder-sw-register.js"></script>
<!-- 百度统计 -->
<script>
var _hmt = _hmt || [];
(function () {
var hm = document.createElement("script");
hm.src = "https://hm.baidu.com/hm.js?de1c4b02a9f8a51a6001797e045d3af9";
var s = document.getElementsByTagName("script")[0];
s.parentNode.insertBefore(hm, s);
})();
</script>
</head><body>
<div id="container">
<div id="wrap">
<header id="header">
<div id="banner"></div>
<div id="header-outer" class="outer">
<div id="header-title" class="inner">
<h1 id="logo-wrap">
<a href="/" id="logo">时代残党</a>
</h1>

<h2 id="subtitle-wrap">
<a href="/" id="subtitle">随手笔记</a>
</h2>

</div>
<div id="header-inner" class="inner">
<nav id="main-nav">
<a id="main-nav-toggle" class="nav-icon"></a>

<a class="main-nav-link" href="/">首页</a>

<a class="main-nav-link" href="/archives">归档</a>

<a class="main-nav-link" href="/app">联系我</a>

</nav>
<div id="search-form-wrap">
<div class="search-form"><input type="search" name="wd" class="search-form-input" placeholder="Search" list="search-datalist" autocomplete="false"/></div>

<input type="hidden" id="search-index-file" value="/search.json" />
<div id="search-form-datalist"></div>

</div>
<nav id="sub-nav">

<a id="nav-search-btn" class="nav-icon" title="搜索"></a>
</nav>
</div>
</div>
</header>
<div class="outer">
<section id="main">
<article id="post-MySQL-regex-for-multi-bytes-character" class="article article-type-post" itemscope itemprop="blogPost">
<div class="article-meta">
<a href="/2022/06/25/MySQL-regex-for-multi-bytes-character/" class="article-date">
  <time datetime="2022-06-25T09:30:04.000Z" itemprop="datePublished">2022-06-25</time>
</a>

</div>
<div class="article-inner">


<header class="article-header">
  
    <h1 class="article-title" itemprop="name">
      MySQL 正则表达式支持多字节字符
    </h1>
  
</header>

<div class="article-entry" itemprop="articleBody">
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>最近在工作中遇到一个小问题，就是需要一些简单的字符串匹配，自然而然想到使用正则表达式了。简单搜索了一下，<code>MySQL</code> 中如何使用正则，基本上都介绍用 <a href="https://dev.mysql.com/doc/refman/8.0/en/regexp.html" target="_blank" rel="noopener">REGEXP</a> 函数。</p>
<p>但是，这个函数有个限制，在 MySQL 8.0.4 之前的版本，它是按字节匹配的，而不是字符！换句话说，对于汉字或者 Emoji 这样多字节的字符，它不支持！</p>
<blockquote>
<p>The REGEXP and RLIKE operators work in byte-wise fashion, so they are not multibyte safe and may produce unexpected results with multibyte character sets. In addition, these operators compare characters by their byte values and accented characters may not compare as equal even if a given collation treats them as equal. <a href="https://dev.mysql.com/doc/refman/5.6/en/regexp.html" target="_blank" rel="noopener"><a href="https://your-link.here" target="_blank" rel="noopener"><fa-link/></a></a></p>
</blockquote>
<p>所以，在 MySQL 8.0.4 之前的版本，我们该如何针对多字节的字符使用正则表达式呢？</p>
<p>升级 MySQL？好吧，当我没问。🙊</p>
<p>针对一个线上的 MySQL，如果要必须要实现业务逻辑，又不能变更 MySQL，有什么好的办法？</p>
<p>不用正则表达式，采用 IF ELSE 语句替代？也不是不可以，但是逻辑稍负责一点，SQL 脚本就开始变得冗长、性能低下且难以维护了。</p>
<p>以下是我自己的经验总结，仅供参考。</p>
<h1 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h1><p>既然 MySQL 8.0.4 之前的 REGEXP 只能支持单字节，那我把多字节字符都替换成单字节字符再正则匹配不就行了？<a href="https://dev.mysql.com/doc/refman/8.0/en/replace.html" target="_blank" rel="noopener">REPLACE</a> 函数是支持多字节的。</p>
<h1 id="放码"><a href="#放码" class="headerlink" title="放码"></a>放码</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">USE</span> <span class="string">`project_otis2019`</span>$$</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">FUNCTION</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`fx_regexp_over_multi_characters_sample`</span>$$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> DEFINER=<span class="string">`zxs66`</span>@<span class="string">`%`</span> <span class="keyword">FUNCTION</span> <span class="string">`fx_regexp_over_multi_characters_sample`</span>(<span class="keyword">content</span> <span class="built_in">TEXT</span>) <span class="keyword">RETURNS</span> <span class="built_in">TINYINT</span>(<span class="number">4</span>)</span><br><span class="line">    <span class="keyword">COMMENT</span> <span class="string">'check if given content match specific regular expression'</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">DECLARE</span> normalized_content <span class="built_in">TEXT</span>;</span><br><span class="line">	<span class="keyword">SET</span> normalized_content=<span class="keyword">REPLACE</span>(<span class="keyword">REPLACE</span>(<span class="keyword">REPLACE</span>(<span class="keyword">REPLACE</span>(<span class="keyword">REPLACE</span>(<span class="keyword">REPLACE</span>(<span class="keyword">REPLACE</span>(</span><br><span class="line">					<span class="keyword">REPLACE</span>(<span class="keyword">REPLACE</span>(<span class="keyword">REPLACE</span>(</span><br><span class="line">						<span class="keyword">REPLACE</span>(<span class="keyword">REPLACE</span>(<span class="keyword">REPLACE</span>(<span class="keyword">REPLACE</span>(<span class="keyword">REPLACE</span>(<span class="keyword">content</span>,<span class="string">'水果'</span>,<span class="string">'`'</span>),<span class="string">'蔬菜'</span>,<span class="string">'`'</span>),<span class="string">'牛奶'</span>,<span class="string">'`'</span>),<span class="string">'牛羊肉'</span>,<span class="string">'`'</span>),<span class="string">'杂粮'</span>,<span class="string">'`'</span>),</span><br><span class="line">						<span class="string">'，'</span>,<span class="string">','</span>),<span class="string">'；'</span>,<span class="string">','</span>),<span class="string">'。'</span>,<span class="string">','</span>),</span><br><span class="line">						<span class="string">'种植'</span>,<span class="string">'@'</span>),<span class="string">'运输'</span>,<span class="string">'@'</span>),<span class="string">'储藏'</span>,<span class="string">'@'</span>),<span class="string">'销售'</span>,<span class="string">'@'</span>),<span class="string">'检验'</span>,<span class="string">'@'</span>),<span class="string">'保供'</span>,<span class="string">'@'</span>),<span class="string">'批发'</span>,<span class="string">'@'</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">-- the regular expression below can be revised based on your actual bussiness requirements.</span></span><br><span class="line">	RETURN normalized_content REGEXP '`[^,;\.]*@' OR normalized_content REGEXP '@[^,;\.]*`'; </span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<h1 id="回顾"><a href="#回顾" class="headerlink" title="回顾"></a>回顾</h1><p>上述脚本仅提供一种思路，肯定不是最优解，还存在诸多弊端，其中一个显而易见的问题就是，替换掉的单字节字符不能与原来的文件内容有冲突。如果有不同意见，还请不吝赐教。</p>

</div>
<footer class="article-footer">
<a data-url="https://zxs66.github.io/2022/06/25/MySQL-regex-for-multi-bytes-character/" data-id="clbz824o8000yju8c65mt1qhz" data-title="MySQL 正则表达式支持多字节字符" class="article-share-link">分享</a>


  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/multi-bytes/" rel="tag">multi-bytes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/regex/" rel="tag">regex</a></li></ul>

</footer>
</div>

<nav id="article-nav">
  
    <a href="/2022/07/14/csv-to-excel-file/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">更新</strong>
      <div class="article-nav-title">
        
          CSV转Excel
        
      </div>
    </a>
  
  
    <a href="/2022/05/20/CSharp-bulk-insert-records-into-MySQL/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">更早</strong>
      <div class="article-nav-title">C# 批量插入记录至 MySQL</div>
    </a>
  
</nav>

</article>


</section>

</div>
<footer id="footer">

<div class="outer"><div id="footer-info" class="inner">&copy; 2022 时代残党<br>
Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></div>
</div></footer>
</div>
<nav id="mobile-nav">

<a href="/" class="mobile-nav-link">home</a>

<a href="/archives" class="mobile-nav-link">archives</a>

<a href="/app" class="mobile-nav-link">contact</a>

</nav>
<!--

<script src="https://cdn.bootcdn.net/ajax/libs/jquery/2.0.3/jquery.min.js" crossorigin="anonymous" integrity="sha256-pXtSQrmprcTB74RsNlFHuJxHK5zXcPrOMx78uWU0ayU&#x3D; sha384-ECTndYny330R2jlSXBiZkdXzAVi0Z&#x2F;iDXJTwV6cp39HECmalqg6+b2sFZFf&#x2F;Y2m6 sha512-epzJ9ms+0Pq+zFMrG1lXVNvjEXgtfKx9iuEWqz3hmbaU2m&#x2F;Dp1pcmpYzuSdDLqX6PMIjzMOyGFwMc+SkgFhMFg&#x3D;&#x3D;"></script>

-->

<script src="/js/script.js" async></script>

</div>
<script>
(function () {
// append image-caption
const images = document.querySelectorAll('article img');
for (let j = 0; j < images.length; j++) {
const $img = images[j];
const altText = $img.getAttribute('alt');
if (altText && altText.length && !$img.classList.contains('inline')) {
const $imgCaption = document.createElement('div');
$imgCaption.classList.add('img-caption');
$imgCaption.innerText = $img.getAttribute('alt');
$img.parentNode.insertBefore($imgCaption, $img.nextSibling);
}}})();
</script>
</body></html>